name: build-ctrlblck-production
on:
    push:
        tags:
            - '**'

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@main
            - name: Enable pnpm via corepack
              run: corepack enable
            - name: Setup node
              uses: actions/setup-node@v4
              with:
                node-version: 21
            - name: Build extension
              run: |
                set -x
                export CTRLBLOCK_DEPLOY_TOKEN=${{ secrets.CTRLBLOCK_DEPLOY_TOKEN }}
                export GIT_SHA=$(git rev-parse --short HEAD)
                pnpm install
                pnpm run build-release
            - name: Upload build
              uses: actions/upload-artifact@v4
              with:
                  name: ctrlblock-release-${{ github.sha }}
                  path: dist/
    deploy:
        runs-on: ubuntu-latest
        needs: build
        steps:
        - uses: actions/download-artifact@v4
          with:
            name: ctrlblock-release-${{ github.sha }}
            path: dist/
        - name: Upload to CWS
          run: |
            set -euo pipefail
            cd dist/; zip -r ctrlblock-${{ github.sha }}.zip ./; cd ..

            # Build a JWT from the service account key and exchange it for an access token
            SA_EMAIL=$(echo '${{ secrets.CWS_SERVICE_ACCOUNT_KEY }}' | jq -r '.client_email')
            SA_PRIVATE_KEY=$(echo '${{ secrets.CWS_SERVICE_ACCOUNT_KEY }}' | jq -r '.private_key')

            b64url() { openssl base64 -e -A | tr '/+' '_-' | tr -d '='; }

            HEADER=$(printf '{"alg":"RS256","typ":"JWT"}' | b64url)
            NOW=$(date +%s)
            CLAIMS=$(printf '{"iss":"%s","scope":"https://www.googleapis.com/auth/chromewebstore","aud":"https://oauth2.googleapis.com/token","iat":%d,"exp":%d}' \
              "$SA_EMAIL" "$NOW" "$((NOW + 3600))" | b64url)
            SIGNATURE=$(printf '%s.%s' "$HEADER" "$CLAIMS" | \
              openssl dgst -sha256 -sign <(printf '%s' "$SA_PRIVATE_KEY") | b64url)

            JWT="${HEADER}.${CLAIMS}.${SIGNATURE}"

            CWS_UPLOAD_TOKEN=$(curl -sf -X POST https://oauth2.googleapis.com/token \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=${JWT}" | \
              jq -r '.access_token')

            curl -sf \
            -H "Authorization: Bearer $CWS_UPLOAD_TOKEN"  \
            -H "x-goog-api-version: 2" \
            -X PUT \
            -T dist/ctrlblock-${{ github.sha }}.zip \
            https://www.googleapis.com/upload/chromewebstore/v1.1/items/${{ secrets.CWS_EXTENSION_ID }}